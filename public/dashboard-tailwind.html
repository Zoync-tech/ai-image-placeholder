<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRC Cloud Instance Manager - Your API Key</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        'primary-dark': '#7c3aed',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-72 bg-gray-800 border-r border-gray-700 fixed h-screen overflow-y-auto lg:translate-x-0 -translate-x-full transition-transform duration-300 z-50" id="sidebar">
            <div class="p-6">
                <!-- Logo Section -->
                <div class="mb-8">
                    <img src="VRCCM Logo.png" alt="VRC Cloud Instance Manager" class="h-10 w-auto mb-3">
                    <h1 class="text-xl font-bold text-white">VRC Cloud Instance Manager</h1>
                    <p class="text-sm text-gray-400">AI Text to Image Generator</p>
                </div>

                <!-- User Profile -->
                <div class="bg-gray-700 rounded-lg p-4 mb-6 border border-gray-600" id="userInfo" style="display: none;">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-semibold mb-3" id="userAvatar">U</div>
                    <div class="text-white font-semibold mb-1" id="userEmail">user@example.com</div>
                    <div class="text-sm text-gray-300 mb-4">Credits: <span id="userCredits" class="text-green-400">0</span></div>
                    <button class="w-full bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                        Upgrade Plan
                    </button>
                </div>

                <!-- Navigation -->
                <div class="space-y-6">
                    <!-- Main Section -->
                    <div>
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Main</h3>
                        <nav class="space-y-1">
                            <a href="#" class="flex items-center px-3 py-2 bg-primary text-white rounded-lg">
                                <span class="mr-3">üè†</span>
                                Dashboard
                            </a>
                            <a href="#" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors">
                                <span class="mr-3">üìö</span>
                                Library
                            </a>
                        </nav>
                    </div>

                    <!-- AI Tools Section -->
                    <div>
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">AI Tools</h3>
                        <nav class="space-y-1">
                            <a href="#" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors">
                                <span class="mr-3">üé®</span>
                                Image Generator
                            </a>
                            <a href="#" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors">
                                <span class="mr-3">üîß</span>
                                API Keys
                            </a>
                        </nav>
                    </div>

                    <!-- Account Section -->
                    <div>
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
                        <nav class="space-y-1">
                            <a href="#" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors">
                                <span class="mr-3">‚öôÔ∏è</span>
                                Settings
                            </a>
                            <a href="#" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors">
                                <span class="mr-3">‚ùì</span>
                                Help & FAQ
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Logout Button -->
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors mt-6">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 lg:ml-72">
            <!-- Header -->
            <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
                <button class="lg:hidden bg-primary text-white px-3 py-2 rounded-lg mb-4" onclick="toggleSidebar()">
                    ‚ò∞ Menu
                </button>
                <h1 class="text-2xl font-bold text-white">Dashboard</h1>
                <p class="text-gray-400">Your Personal API Key & Image Generation</p>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6">
                <!-- User Info Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center" id="userInfoMain" style="display: none;">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">Welcome, <span id="userEmailMain"></span>!</h3>
                    <p class="text-blue-800 mb-1">Credits Remaining: <span class="text-green-600 font-bold" id="userCreditsMain">0</span></p>
                    <p class="text-blue-800 mb-1">Total Generations: <span id="totalGenerations">0</span></p>
                    <p class="text-blue-800">Account Created: <span id="accountCreated"></span></p>
                </div>

                <!-- API Key Section -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-6 text-center">Your API Key</h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" id="noApiKey" style="display: none;">
                        <p class="text-blue-800">Creating your API key...</p>
                    </div>

                    <div class="bg-white border-2 border-primary rounded-lg p-6 text-center" id="apiKeySection" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Your API Key:</h3>
                        <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-4 font-mono text-sm text-gray-800 break-all" id="apiKeyDisplay"></div>
                        <button onclick="copyApiKey()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            Copy API Key
                        </button>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Image URL:</h3>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 font-mono text-sm text-green-800 break-all" id="urlDisplay"></div>
                            <button onclick="copyUrl()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                Copy URL
                            </button>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Usage Instructions:</h3>
                            <p class="text-gray-700 mb-2">Replace <strong>YOUR_TEXT</strong> with your image description and <strong>WIDTHxHEIGHT</strong> with your desired dimensions.</p>
                            <p class="text-gray-700">Example: <code class="bg-gray-100 px-2 py-1 rounded">600x400.jpg?api_key=YOUR_API_KEY&text=cat+flying</code></p>
                        </div>
                    </div>

                    <div class="text-center py-8" id="loading">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <p class="text-gray-400 mt-2">Creating your API key...</p>
                    </div>

                    <div class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4" id="errorMessage">
                        <p class="text-red-800"></p>
                    </div>
                    <div class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4" id="successMessage">
                        <p class="text-green-800"></p>
                    </div>
                </div>

                <!-- Demo Section -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-6 text-center">Try It Now</h2>
                    <p class="text-gray-300 mb-6 text-center">Test the AI Text to Image Generator with your API key:</p>
                    
                    <form id="demoForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Image Prompt</label>
                            <textarea id="demoPrompt" placeholder="Describe the image you want to generate... (e.g., 'a beautiful sunset over mountains', 'abstract art with vibrant colors')" rows="3" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Width</label>
                                <input type="number" id="demoWidth" value="600" min="1" max="4096" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Height</label>
                                <input type="number" id="demoHeight" value="400" min="1" max="4096" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Quick Size Presets:</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="setSize(600, 400)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">600√ó400</button>
                                <button type="button" onclick="setSize(800, 600)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">800√ó600</button>
                                <button type="button" onclick="setSize(1024, 768)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">1024√ó768</button>
                                <button type="button" onclick="setSize(1920, 1080)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">1920√ó1080</button>
                                <button type="button" onclick="setSize(512, 512)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">512√ó512</button>
                                <button type="button" onclick="setSize(1024, 1024)" class="px-4 py-2 bg-gray-700 hover:bg-primary text-white rounded-lg text-sm transition-colors">1024√ó1024</button>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="btn-text">Generate AI Image</span>
                                <div class="loading hidden">
                                    <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                                    Generating AI image from text...
                                </div>
                            </button>
                            
                            <button type="button" onclick="generateLink()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors">
                                Generate Link
                            </button>
                        </div>
                    </form>

                    <div class="bg-gray-700 border border-gray-600 rounded-lg p-4 mt-6 hidden" id="linkSection">
                        <h4 class="text-lg font-semibold text-white mb-3">Generated URL</h4>
                        <div class="flex gap-3">
                            <input type="text" id="generatedUrl" readonly class="flex-1 px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-900 font-mono text-sm">
                            <button onclick="copyUrl()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Copy URL
                            </button>
                        </div>
                    </div>

                    <div class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-4" id="demoErrorMessage">
                        <p class="text-red-800"></p>
                    </div>
                </div>

                <!-- Generated Image -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-white mb-4">Generated Image</h4>
                    <div class="bg-white border border-gray-300 rounded-lg p-8 text-center min-h-[200px] flex items-center justify-center" id="demoImageContainer">
                        <div class="text-gray-500 italic">
                            Enter a text prompt and click "Generate AI Image" to create your image
                        </div>
                    </div>
                </div>

                <!-- Image Generations History -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-6 text-center">Your Generated Images</h2>
                    <div id="imageGenerations">
                        <div class="text-center py-8" id="generationsLoading">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                            <p class="text-gray-400 mt-2">Loading your image history...</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden" id="noGenerations">
                            <p class="text-blue-800">No images generated yet. Use your API key to create your first AI image!</p>
                        </div>
                        <div class="space-y-4 hidden" id="generationsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userApiKey = '';

        // Load user data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
            await loadUserApiKey();
            await loadImageGenerations();
        });

        async function checkAuthStatus() {
            const token = localStorage.getItem('userToken');
            const email = localStorage.getItem('userEmail');
            
            console.log('üîç Checking auth status:', { token: token ? 'SET' : 'NOT SET', email });
            
            if (token && email) {
                // User is logged in, show user info
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfoMain').style.display = 'block';
                document.getElementById('userEmailMain').textContent = email;
                
                // Load user data
                try {
                    console.log('üì° Fetching user profile with token:', token.substring(0, 20) + '...');
                    const response = await fetch('/api/user/profile', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    console.log('üìä Profile response status:', response.status);
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('‚úÖ User data loaded:', userData);
                        document.getElementById('userCredits').textContent = userData.credits || 0;
                        document.getElementById('userCreditsMain').textContent = userData.credits || 0;
                        document.getElementById('totalGenerations').textContent = userData.total_generations || 0;
                        document.getElementById('accountCreated').textContent = new Date(userData.created_at).toLocaleDateString();
                        
                        // Update sidebar user info
                        const userAvatar = document.getElementById('userAvatar');
                        const userEmailSidebar = document.getElementById('userEmail');
                        if (userAvatar && userEmailSidebar) {
                            userAvatar.textContent = email.charAt(0).toUpperCase();
                            userEmailSidebar.textContent = email;
                        }
                    } else if (response.status === 401) {
                        console.log('‚ùå Token expired or invalid, redirecting to login');
                        localStorage.removeItem('userToken');
                        localStorage.removeItem('userEmail');
                        window.location.href = '/auth.html';
                    } else {
                        console.log('‚ùå Unexpected response status:', response.status);
                        const errorText = await response.text();
                        console.log('‚ùå Error response:', errorText);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading user data:', error);
                }
            } else {
                console.log('‚ùå No token or email found, redirecting to login');
                // User not logged in, redirect to auth page
                window.location.href = '/auth.html';
            }
        }

        async function loadUserApiKey() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                // Get user's API keys
                const response = await fetch('/api/user/api-keys', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.api_keys && data.api_keys.length > 0) {
                        // User has an API key
                        userApiKey = data.api_keys[0].api_key;
                        document.getElementById('noApiKey').style.display = 'none';
                        document.getElementById('apiKeySection').style.display = 'block';
                        document.getElementById('apiKeyDisplay').textContent = userApiKey;
                        
                        // Create the URL
                        const baseUrl = window.location.origin;
                        const imageUrl = `${baseUrl}/WIDTHxHEIGHT.jpg?api_key=${userApiKey}&text=YOUR_TEXT`;
                        document.getElementById('urlDisplay').textContent = imageUrl;
                    } else {
                        // User has no API key - auto-create one
                        console.log('No API key found, auto-creating one...');
                        await createApiKey();
                    }
                } else {
                    console.error('Failed to load API keys:', response.status);
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        async function createApiKey() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                showError('errorMessage', 'Please login first');
                return;
            }
            
            showLoading('loading');
            hideMessages();
            
            try {
                const response = await fetch('/api/create-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name: 'My API Key' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccess(`API key created successfully! You have ${data.credits} credits remaining.`);
                    
                    // Update the display
                    userApiKey = data.api_key;
                    document.getElementById('noApiKey').style.display = 'none';
                    document.getElementById('apiKeySection').style.display = 'block';
                    document.getElementById('apiKeyDisplay').textContent = userApiKey;
                    
                    // Create the URL
                    const baseUrl = window.location.origin;
                    const imageUrl = `${baseUrl}/WIDTHxHEIGHT.jpg?api_key=${userApiKey}&text=YOUR_TEXT`;
                    document.getElementById('urlDisplay').textContent = imageUrl;
                    
                    // Refresh user info
                    await checkAuthStatus();
                } else {
                    const error = await response.json();
                    showError('errorMessage', error.error || 'Failed to create API key');
                }
            } catch (error) {
                showError('errorMessage', 'Failed to create API key');
            }
            
            hideLoading('loading');
        }

        function copyApiKey() {
            navigator.clipboard.writeText(userApiKey).then(() => {
                showSuccess('API key copied to clipboard!');
            }).catch(() => {
                showError('errorMessage', 'Failed to copy API key');
            });
        }

        function copyUrl() {
            const url = document.getElementById('urlDisplay').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('URL copied to clipboard!');
            }).catch(() => {
                showError('errorMessage', 'Failed to copy URL');
            });
        }

        function logout() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userEmail');
            window.location.href = '/auth.html';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function showLoading(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideLoading(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showError(id, message) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const element = document.getElementById('successMessage');
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        async function loadImageGenerations() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                const response = await fetch('/api/user/image-generations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayImageGenerations(data.generations);
                } else {
                    console.error('Failed to load image generations:', response.status);
                    document.getElementById('generationsLoading').style.display = 'none';
                    document.getElementById('noGenerations').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading image generations:', error);
                document.getElementById('generationsLoading').style.display = 'none';
                document.getElementById('noGenerations').classList.remove('hidden');
            }
        }

        function displayImageGenerations(generations) {
            document.getElementById('generationsLoading').style.display = 'none';
            
            if (!generations || generations.length === 0) {
                document.getElementById('noGenerations').classList.remove('hidden');
                return;
            }

            const baseUrl = window.location.origin;
            const generationsList = document.getElementById('generationsList');
            
            generations.forEach(generation => {
                const generationItem = document.createElement('div');
                generationItem.className = 'bg-white border border-gray-300 rounded-lg p-4 flex items-center gap-4 hover:shadow-lg transition-shadow';
                
                // Use Supabase Storage URL if available, otherwise fallback to API URL
                let imageUrl, displayUrl;
                if (generation.public_url) {
                    imageUrl = generation.public_url;
                    displayUrl = generation.public_url;
                } else {
                    imageUrl = `${baseUrl}/${generation.dimensions}.jpg?api_key=${userApiKey}&text=${encodeURIComponent(generation.prompt)}`;
                    displayUrl = imageUrl;
                }
                
                generationItem.innerHTML = `
                    <img src="${imageUrl}" alt="${generation.prompt}" class="w-20 h-20 rounded-lg object-cover border-2 border-gray-300" onerror="this.style.display='none'">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900 mb-1 text-sm">${generation.prompt}</div>
                        <div class="text-gray-600 text-xs mb-1">Dimensions: ${generation.dimensions}</div>
                        <div class="text-gray-600 text-xs mb-2">Generated: ${new Date(generation.created_at).toLocaleString()}</div>
                        <div class="bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs text-gray-600 break-all font-mono">${displayUrl}</div>
                    </div>
                `;
                
                generationsList.appendChild(generationItem);
            });
            
            document.getElementById('generationsList').classList.remove('hidden');
        }

        // Demo functionality
        const demoForm = document.getElementById('demoForm');
        const demoPromptInput = document.getElementById('demoPrompt');
        const demoWidthInput = document.getElementById('demoWidth');
        const demoHeightInput = document.getElementById('demoHeight');
        const demoImageContainer = document.getElementById('demoImageContainer');
        const demoErrorMessage = document.getElementById('demoErrorMessage');
        const demoGenerateBtn = demoForm.querySelector('button[type="submit"]');
        const demoBtnText = demoForm.querySelector('.btn-text');
        const demoLoading = demoForm.querySelector('.loading');
        const linkSection = document.getElementById('linkSection');
        const generatedUrlInput = document.getElementById('generatedUrl');

        demoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const prompt = demoPromptInput.value || 'abstract art';
            const width = demoWidthInput.value;
            const height = demoHeightInput.value;

            if (!userApiKey) {
                demoErrorMessage.textContent = 'Please wait for your API key to load.';
                demoErrorMessage.classList.remove('hidden');
                return;
            }

            // Show loading state
            demoGenerateBtn.disabled = true;
            demoBtnText.style.display = 'none';
            demoLoading.classList.remove('hidden');
            demoErrorMessage.classList.add('hidden');

            try {
                const url = `/${width}x${height}.jpg?api_key=${userApiKey}&text=${encodeURIComponent(prompt)}`;
                
                // Create image element
                const img = new Image();
                img.className = 'max-w-full max-h-96 rounded-lg shadow-lg';
                
                img.onload = function() {
                    demoImageContainer.innerHTML = '';
                    demoImageContainer.appendChild(img);
                    
                    // Hide loading
                    demoGenerateBtn.disabled = false;
                    demoBtnText.style.display = 'block';
                    demoLoading.classList.add('hidden');
                };

                img.onerror = function() {
                    throw new Error('Failed to load image');
                };

                img.src = url;

            } catch (error) {
                console.error('Error:', error);
                demoErrorMessage.textContent = 'Failed to generate image. Please try again.';
                demoErrorMessage.classList.remove('hidden');
                
                // Hide loading
                demoGenerateBtn.disabled = false;
                demoBtnText.style.display = 'block';
                demoLoading.classList.add('hidden');
            }
        });

        // Generate Link function
        function generateLink() {
            const prompt = demoPromptInput.value || 'abstract art';
            const width = demoWidthInput.value;
            const height = demoHeightInput.value;

            if (!userApiKey) {
                demoErrorMessage.textContent = 'Please wait for your API key to load.';
                demoErrorMessage.classList.remove('hidden');
                return;
            }

            const baseUrl = window.location.origin;
            const url = `${baseUrl}/${width}x${height}.jpg?api_key=${userApiKey}&text=${encodeURIComponent(prompt)}`;
            
            generatedUrlInput.value = url;
            linkSection.classList.remove('hidden');
            demoErrorMessage.classList.add('hidden');
        }

        // Set size function for preset buttons
        function setSize(width, height) {
            document.getElementById('demoWidth').value = width;
            document.getElementById('demoHeight').value = height;
        }
    </script>
</body>
</html>
